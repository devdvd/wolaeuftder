<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wol√§uftder... Server</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .match {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }
        .match-date {
            font-weight: bold;
            color: #007bff;
        }
        .teams {
            font-size: 1.1em;
            margin: 5px 0;
        }
        .broadcaster {
            color: #666;
            font-style: italic;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .json-output {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            overflow-x: auto;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
        }
        .team-selector {
            margin: 20px 0;
            text-align: center;
        }
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚öΩ wol√§uftder... Server</h1>
        <p>Sammelt alle TV-Termine der aktuellen Bundesliga-Saison</p>
    </div>

    <div class="controls">
        <button id="scrapeBtn" onclick="startScraping()">üöÄ TV-Termine sammeln</button>
        <button id="downloadBtn" onclick="downloadJSON()" disabled>üì• JSON Download</button>
        <button id="copyBtn" onclick="copyToClipboard()" disabled>üìã JSON kopieren</button>
    </div>

    <div class="team-selector">
        <label for="teamSelect">Filter nach Verein:</label>
        <select id="teamSelect" onchange="filterByTeam()">
            <option value="">Alle Vereine</option>
        </select>
    </div>

    <div id="status" class="status loading" style="display: none;">
        Sammle TV-Termine...
    </div>

    <div id="matches"></div>

    <div class="json-output" id="jsonOutput" style="display: none;">
        <h3>üìÑ JSON Daten f√ºr GitHub Pages:</h3>
        <pre id="jsonData"></pre>
    </div>

    <script>
        let allMatches = [];
        let teams = new Set();
        let currentSeason = '2025-2026';

        async function startScraping() {
            const statusDiv = document.getElementById('status');
            const scrapeBtn = document.getElementById('scrapeBtn');
            const matchesDiv = document.getElementById('matches');
            
            scrapeBtn.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.className = 'status loading';
            statusDiv.textContent = 'Lade TV-Termine...';
            matchesDiv.innerHTML = '';
            allMatches = [];
            teams.clear();

            try {
                // Versuche echte Daten zu laden
                statusDiv.textContent = 'Lade echte Bundesliga-Daten...';
                const dataResult = await loadDataFromJSON();
                
                if (dataResult.success) {
                    // Echte Daten erfolgreich geladen
                    allMatches = dataResult.matches;
                    
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `‚úÖ Erfolgreich! ${dataResult.totalMatches} Spiele geladen (Spieltag ${dataResult.currentSpieltag})`;
                    
                    // Zeige die Spiele an
                    allMatches.forEach(match => {
                        displayMatches([match]);
                    });
                    
                } else {
                    // Fallback: Generiere Demo-Daten
                    statusDiv.textContent = 'Generiere Fallback-Daten...';
                    
                    const fallbackMatches = await generateFallbackData();
                    allMatches = fallbackMatches;
                    
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `‚ö†Ô∏è Fallback-Daten: ${allMatches.length} Demo-Spiele generiert`;
                    
                    // Zeige die Spiele an
                    allMatches.forEach(match => {
                        displayMatches([match]);
                    });
                }
                
                // Aktiviere Download-Buttons
                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('copyBtn').disabled = false;
                
                // Zeige JSON
                displayJSON();
                
                // F√ºlle Team-Selector
                populateTeamSelector();

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `‚ùå Fehler: ${error.message}`;
                console.error('Loading error:', error);
            } finally {
                scrapeBtn.disabled = false;
            }
        }

        async function loadDataFromJSON() {
            // Versuche echte Daten aus der JSON-Datei zu laden
            try {
                const response = await fetch('./backend/bundesliga-tv-termine.json');
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Echte Daten geladen:', data.totalMatches, 'Spiele');
                    
                    // Konvertiere zu dem erwarteten Format
                    allMatches = data.matches || [];
                    
                    // Sammle Teams
                    teams.clear();
                    data.teams?.forEach(team => teams.add(team));
                    
                    return {
                        success: true,
                        matches: allMatches,
                        totalMatches: data.totalMatches,
                        currentSpieltag: data.currentSpieltag
                    };
                } else {
                    throw new Error('JSON-Datei nicht gefunden');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Fehler beim Laden der echten Daten:', error.message);
                return { success: false, error: error.message };
            }
        }

        async function generateFallbackData() {
            // Fallback: Generiere Demo-Daten wenn keine echten Daten verf√ºgbar
            console.log('üìù Generiere Fallback-Daten...');
            
            const teamsList = [
                'FC Bayern M√ºnchen', 'Borussia Dortmund', 'RB Leipzig', 'Bayer 04 Leverkusen',
                'Borussia M√∂nchengladbach', 'VfL Wolfsburg', 'Eintracht Frankfurt', 'TSG Hoffenheim',
                'Sport-Club Freiburg', '1. FC Union Berlin', 'VfB Stuttgart', 'SV Werder Bremen',
                'FC Augsburg', '1. FSV Mainz 05', '1. FC K√∂ln', 'FC St. Pauli',
                'Hamburger SV', '1. FC Heidenheim 1846'
            ];

            const broadcasters = [
                { name: 'Sky Deutschland', logo: 'sky' },
                { name: 'DAZN', logo: 'dazn' },
                { name: 'WOW', logo: 'wow' }
            ];

            const matches = [];
            const today = new Date();
            
            // Generiere 5 Spieltage mit je 9 Spielen
            for (let spieltag = 3; spieltag <= 7; spieltag++) {
                const baseDate = new Date(today);
                baseDate.setDate(today.getDate() + (spieltag - 3) * 7);

                for (let i = 0; i < 9; i++) {
                    const homeTeam = teamsList[i * 2];
                    const awayTeam = teamsList[i * 2 + 1];
                    const matchDate = new Date(baseDate);
                    
                    // Verschiedene Kickoff-Zeiten
                    if (i === 0) {
                        matchDate.setDate(matchDate.getDate() + 5); // Freitag
                        matchDate.setHours(20, 30, 0, 0);
                    } else if (i < 6) {
                        matchDate.setDate(matchDate.getDate() + 6); // Samstag
                        matchDate.setHours(i === 5 ? 18 : 15, 30, 0, 0);
                    } else {
                        matchDate.setDate(matchDate.getDate() + 7); // Sonntag
                        matchDate.setHours(i === 7 ? 15 : 17, 30, 0, 0);
                    }

                    const broadcaster = broadcasters[i % broadcasters.length];

                    matches.push({
                        spieltag: spieltag,
                        homeTeam: homeTeam,
                        awayTeam: awayTeam,
                        date: matchDate.toISOString(),
                        dateFormatted: formatDateTime(matchDate),
                        kickoff: matchDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }),
                        broadcaster: broadcaster.name,
                        broadcasterLogo: broadcaster.logo,
                        season: currentSeason
                    });
                }
            }

            // Sammle Teams
            teams.clear();
            teamsList.forEach(team => teams.add(team));
            
            return matches;
        }

        function formatDateTime(date) {
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            return date.toLocaleDateString('de-DE', options);
        }

        function displayMatches(matches) {
            const matchesDiv = document.getElementById('matches');
            
            matches.forEach(match => {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'match';
                matchDiv.innerHTML = `
                    <div class="match-date">${match.dateFormatted} ‚Ä¢ ${match.kickoff} Uhr</div>
                    <div class="teams">${match.homeTeam} vs ${match.awayTeam}</div>
                    <div class="broadcaster">üì∫ ${match.broadcaster}</div>
                    <div style="font-size: 0.9em; color: #666;">Spieltag ${match.spieltag}</div>
                `;
                matchesDiv.appendChild(matchDiv);
            });
        }

        function displayJSON() {
            const jsonOutput = document.getElementById('jsonOutput');
            const jsonData = document.getElementById('jsonData');
            
            const output = {
                lastUpdated: new Date().toISOString(),
                season: currentSeason,
                totalMatches: allMatches.length,
                teams: Array.from(teams).sort(),
                matches: allMatches
            };

            jsonData.textContent = JSON.stringify(output, null, 2);
            jsonOutput.style.display = 'block';
        }

        function populateTeamSelector() {
            const teamSelect = document.getElementById('teamSelect');
            teamSelect.innerHTML = '<option value="">Alle Vereine</option>';
            
            Array.from(teams).sort().forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamSelect.appendChild(option);
            });
        }

        function filterByTeam() {
            const selectedTeam = document.getElementById('teamSelect').value;
            const matchesDiv = document.getElementById('matches');
            
            if (!selectedTeam) {
                matchesDiv.innerHTML = '';
                allMatches.forEach(match => displayMatches([match]));
                return;
            }

            const filteredMatches = allMatches.filter(match => 
                match.homeTeam === selectedTeam || match.awayTeam === selectedTeam
            );

            matchesDiv.innerHTML = '';
            filteredMatches.forEach(match => displayMatches([match]));
        }

        function downloadJSON() {
            const output = {
                lastUpdated: new Date().toISOString(),
                season: currentSeason,
                totalMatches: allMatches.length,
                teams: Array.from(teams).sort(),
                matches: allMatches
            };

            const dataStr = JSON.stringify(output, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `bundesliga-tv-termine.json`;
            link.click();
        }

        function copyToClipboard() {
            const jsonData = document.getElementById('jsonData');
            navigator.clipboard.writeText(jsonData.textContent).then(() => {
                const copyBtn = document.getElementById('copyBtn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ Kopiert!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            });
        }

        // Auto-start demo when page loads
        window.addEventListener('load', () => {
            setTimeout(startScraping, 1000);
        });
    </script>
</body>
</html>